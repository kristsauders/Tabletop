{"ts":1347042974591,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var express = require('express'),\n\tapp = express.createServer(),\n\trest = require('restler'),\n\tejs = require('ejs'),\n\tmongo = require('mongodb'),\n\turl = require(\"url\"),\n\tfs = require('fs'),\n\tsys = require('sys'),\n\tdb = new mongo.Db('tabletop', new mongo.Server(\"127.0.0.1\", 27017, {\n\t\tauto_reconnect: true\n\t}), {}),\n\tim = require('imagemagick');\n\nim.identify.path = '/usr/bin/identify';\nim.convert.path = '/usr/bin/convert';\n\napp.use(express.cookieParser());\napp.use(express.session({\n\tsecret: \"thisIsSparta!\"\n}));\napp.use(express.bodyParser({\n\tuploadDir: __dirname + '/images'\n}));\n\napp.set('view engine', 'ejs');\napp.set('views', __dirname + '/views');\napp.use('/js', express.static(__dirname + '/js'));\napp.use('/images', express.static(__dirname + '/images'));\n\napp.get('/:user/:gallery/draw', function(req, res) {\n    console.log('got draw request');\n    res.render('draw', {\n\t\tlayout: false,\n\t\tdata: {}\n\t});\n});\n\napp.get('/:user/:gallery/photos/new', function(req, res) {\n    console.log('got new photo get');\n\tres.send('<form method=\"post\" enctype=\"multipart/form-data\">' + '<p>Image: <input type=\"file\" name=\"image\" multiple/></p>' + '<p><input type=\"submit\" value=\"Upload\" /></p>' + '</form>');\n});\n\nfunction processUpload(req, res) {\n    im.convert([req.files.image.path, '-quality', '85', '-resize', '900x900\\>', req.files.image.path.split('.')[0] + '-medium.jpg'], function(err) {\n    \tif (err) throw err;\n\t});\n    \n    im.convert([req.files.image.path, '-quality', '85', '-resize', '1600x1600\\>', req.files.image.path.split('.')[0] + '-large.jpg'], function(err) {\n        if (err) throw err;\n\t});\n    \n\tim.convert([req.files.image.path, '-quality', '80', '-resize', '400x400\\>', req.files.image.path.split('.')[0] + '-small.jpg'], function(err) {\n\t\tif (err) throw err;\n\t\tdb.open(function(err, db) {\n\t\t\tdb.collection('users', function(err, collection) {\n\t\t\t\tcollection.findOne({\n\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tvar gal = document.galleries[req.params.gallery];\n\t\t\t\t\tvar p = 0;\n\t\t\t\t\tfor (var i in gal) p += 1;\n\t\t\t\t\tgal[p] = new Object();\n\t\t\t\t\tgal[p].source = '/images/' + req.files.image.path.split('/').pop()+'.jpg';;\n\t\t\t\t\tgal[p].top = Math.floor(Math.random() * 701);\n\t\t\t\t\tgal[p].left = Math.floor(Math.random() * 901);\n\t\t\t\t\tgal[p].link = '';\n\t\t\t\t\tim.identify(req.files.image.path, function(err, features) {\n\t\t\t\t\t\tvar ratio = features.width / features.height;\n\t\t\t\t\t\tgal[p].width = Math.round(Math.random() * 100) + 150;\n\t\t\t\t\t\tgal[p].height = Math.round(gal[p].width / ratio);\n\t\t\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n\t\t\t\t\t\tcollection.update({\n\t\t\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t\t\t}, document, {\n\t\t\t\t\t\t\tupsert: true,\n\t\t\t\t\t\t\tsafe: true\n\t\t\t\t\t\t}, function(err, document) {\n\t\t\t\t\t\t\tdb.close();\n\t\t\t\t\t\t\tres.redirect('back');\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n}\n\nfunction processUploads(req, res, k) {\n\tif (req.files.image[k]) {\n\t\tim.convert([req.files.image[k].path, '-quality', '85', '-resize', '900x900\\>', req.files.image[k].path.split('.')[0] + '-medium.jpg'], function(err) {\n\t\t\tif (err) throw err;\n\t\t});\n\t\n\t\tim.convert([req.files.image[k].path, '-quality', '85', '-resize', '1600x1600\\>', req.files.image[k].path.split('.')[0] + '-large.jpg'], function(err) {\n\t\t\tif (err) throw err;\n\t\t});\n        \n\t\tim.convert([req.files.image[k].path, '-quality', '80', '-resize', '400x400\\>', req.files.image[k].path.split('.')[0] + '-small.jpg'], function(err) {\n\t\t\tif (err) throw err;\n\t\t\tdb.open(function(err, db) {\n\t\t\t\tdb.collection('users', function(err, collection) {\n\t\t\t\t\tcollection.findOne({\n\t\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t\t}, function(err, document) {\n\t\t\t\t\t\tvar gal = document.galleries[req.params.gallery];\n\t\t\t\t\t\tvar p = 0;\n\t\t\t\t\t\tfor (var i in gal) p += 1;\n\t\t\t\t\t\tgal[p] = new Object();\n\t\t\t\t\t\tgal[p].source = '/images/' + req.files.image[k].path.split('/').pop()+'.jpg';\n\t\t\t\t\t\tgal[p].top = Math.floor(Math.random() * 701);\n\t\t\t\t\t\tgal[p].left = Math.floor(Math.random() * 901);\n\t\t\t\t\t\tgal[p].link = '';\n\t\t\t\t\t\tim.identify(req.files.image[k].path, function(err, features) {\n\t\t\t\t\t\t\tvar ratio = features.width / features.height;\n\t\t\t\t\t\t\tgal[p].width = Math.round(Math.random() * 100) + 150;\n\t\t\t\t\t\t\tgal[p].height = Math.round(gal[p].width / ratio);\n\t\t\t\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n\t\t\t\t\t\t\tcollection.update({\n\t\t\t\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t\t\t\t}, document, {\n\t\t\t\t\t\t\t\tupsert: true,\n\t\t\t\t\t\t\t\tsafe: true\n\t\t\t\t\t\t\t}, function(err, document) {\n\t\t\t\t\t\t\t\tdb.close();\n\t\t\t\t\t\t\t\tk += 1;\n\t\t\t\t\t\t\t\tprocessUploads(req, res, k);\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\telse {\n\t\tres.redirect('back');\n\t}\n}\n\napp.post('/:user/:gallery/photos/new', function(req, res, next) {\n    console.log('got new photo post');\n\tif (req.files.image.path) processUpload(req, res);\n\telse {\n\t\tprocessUploads(req, res, 0);\n\t}\n});\n\napp.post('/:user/:gallery/photos/drawn/uploadDrawnImage', function(req, res) {\n    console.log('Got uploaded drawn image');\n    var data = req.body.f1.replace(/^data:image\\/\\w+;base64,/, \"\");\n\tvar buf = new Buffer(data, 'base64');\n    var path = __dirname + '/images/' + Math.round(Math.random()*100000) + '.png';\n\tfs.writeFile(path, buf, function() {\n        im.convert([path, '-quality', '85', '-resize', '900x900\\>', path.split('.')[0] + '-medium.png'], function(err) {\n            if (err) throw err;\n        });\n    \n        im.convert([path, '-quality', '85', '-resize', '1600x1600\\>', path.split('.')[0] + '-large.png'], function(err) {\n            if (err) throw err;\n    \t});\n        \n    \tim.convert([path, '-quality', '80', '-resize', '400x400\\>', path.split('.')[0] + '-small.png'], function(err) {\n    \t\tif (err) throw err;\n    \t\tdb.open(function(err, db) {\n    \t\t\tdb.collection('users', function(err, collection) {\n    \t\t\t\tcollection.findOne({\n    \t\t\t\t\t\"user\": req.params.user\n    \t\t\t\t}, function(err, document) {\n    \t\t\t\t\tvar gal = document.galleries[req.params.gallery];\n    \t\t\t\t\tvar p = 0;\n    \t\t\t\t\tfor (var i in gal) p += 1;\n    \t\t\t\t\tgal[p] = new Object();\n    \t\t\t\t\tgal[p].source = '/images/' + path.split('/').pop()+'.jpg';;\n    \t\t\t\t\tgal[p].top = Math.floor(Math.random() * 701);\n    \t\t\t\t\tgal[p].left = Math.floor(Math.random() * 901);\n    \t\t\t\t\tgal[p].link = '';\n    \t\t\t\t\tim.identify(path, function(err, features) {\n    \t\t\t\t\t\tvar ratio = features.width / features.height;\n    \t\t\t\t\t\tgal[p].width = Math.round(Math.random() * 100) + 150;\n    \t\t\t\t\t\tgal[p].height = Math.round(gal[p].width / ratio);\n    \t\t\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n    \t\t\t\t\t\tcollection.update({\n    \t\t\t\t\t\t\t\"user\": req.params.user\n    \t\t\t\t\t\t}, document, {\n    \t\t\t\t\t\t\tupsert: true,\n    \t\t\t\t\t\t\tsafe: true\n    \t\t\t\t\t\t}, function(err, document) {\n    \t\t\t\t\t\t\tdb.close();\n    \t\t\t\t\t\t\tres.redirect('back');\n    \t\t\t\t\t\t});\n    \t\t\t\t\t});\n    \t\t\t\t});\n    \t\t\t});\n    \t\t});\n    \t});\n    });\n});\n\napp.post('/:user/:gallery/uploadBackground', function(req, res, next) {\n    console.log('gotten background');\n\tvar data = req.body.f1.replace(/^data:image\\/\\w+;base64,/, \"\");\n\tvar buf = new Buffer(data, 'base64');\n\tfs.writeFile(__dirname + '/images/' + req.params.user + '-' + req.params.gallery + '-bg.png', buf);\n\tres.redirect('back');\n});\n\napp.post('/:user/:gallery/photos/newlink', function(req, res, next) {\n    console.log('got new link photo');\n    im.convert([req.files.image.path, '-quality', '85', '-resize', '900x900\\>', req.files.image.path.split('.')[0] + '-medium.jpg'], function(err) {\n        if (err) throw err;\n\t});\n    \n    im.convert([req.files.image.path, '-quality', '85', '-resize', '1600x1600\\>', req.files.image.path.split('.')[0] + '-large.jpg'], function(err) {\n        if (err) throw err;\n\t});\n    \n\tim.convert([req.files.image.path, '-quality', '50', '-resize', '400x400\\>', req.files.image.path.split('.')[0] + '-small.jpg'], function(err) {\n\t\tif (err) throw err;\n\t\tdb.open(function(err, db) {\n\t\t\tdb.collection('users', function(err, collection) {\n\t\t\t\tcollection.findOne({\n\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tvar gal = document.galleries[req.params.gallery];\n\t\t\t\t\tvar p = 0;\n\t\t\t\t\tfor (var i in gal) p += 1;\n\t\t\t\t\tgal[p] = new Object();\n\t\t\t\t\tgal[p].source = '/images/' + req.files.image.path.split('/').pop()+'.jpg';;\n\t\t\t\t\tgal[p].top = Math.floor(Math.random() * 701);\n\t\t\t\t\tgal[p].left = Math.floor(Math.random() * 901);\n\t\t\t\t\tgal[p].link = req.body.link;\n\t\t\t\t\tim.identify(req.files.image.path, function(err, features) {\n\t\t\t\t\t\tvar ratio = features.width / features.height;\n\t\t\t\t\t\tgal[p].width = Math.round(Math.random() * 100) + 150;\n\t\t\t\t\t\tgal[p].height = Math.round(gal[p].width / ratio);\n\t\t\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n\t\t\t\t\t\tcollection.update({\n\t\t\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t\t\t}, document, {\n\t\t\t\t\t\t\tupsert: true,\n\t\t\t\t\t\t\tsafe: true\n\t\t\t\t\t\t}, function(err, document) {\n\t\t\t\t\t\t\tdb.close();\n\t\t\t\t\t\t\tres.redirect('back');\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.get('/:user/:gallery', function(req, res) {\n    //req.session.user = 'krists';\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tif (document) {\n\t\t\t\t\tif (document.galleries[req.params.gallery]) {\n\t\t\t\t\t\tif (req.session.user == req.params.user) res.render('index', {\n\t\t\t\t\t\t\tlayout: false,\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\timages: document.galleries[req.params.gallery],\n\t\t\t\t\t\t\t\tparams: req.params\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t\telse res.render('public', {\n\t\t\t\t\t\t\tlayout: false,\n\t\t\t\t\t\t\tdata: {\n\t\t\t\t\t\t\t\timages: document.galleries[req.params.gallery],\n\t\t\t\t\t\t\t\tparams: req.params\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\telse res.send('Gallery does not exist!');\n\t\t\t\t}\n\t\t\t\telse res.send('User does not exist!');\n\t\t\t\tdb.close();\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.post('/:user/:gallery/upsert', function(req, res) {\n    console.log('upsert');\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tvar gal = document.galleries[req.params.gallery];\n\t\t\t\tvar p = 0;\n\t\t\t\tfor (var i in gal) {\n\t\t\t\t\tif (gal[p].source.split('/').pop() == req.body.image) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp += 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tgal[p].source = '/images/' + req.body.image;\n\t\t\t\tgal[p].top = req.body.top;\n\t\t\t\tgal[p].left = req.body.side;\n\t\t\t\tgal[p].width = req.body.width;\n\t\t\t\tgal[p].height = req.body.height;\n\t\t\t\tgal[p].z = req.body.z;\n\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n\t\t\t\tcollection.update({\n\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t}, document, {\n\t\t\t\t\tupsert: true,\n\t\t\t\t\tsafe: true\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tdb.close();\n\t\t\t\t});\n\t\t\t\tres.redirect('back');\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.post('/:user/:gallery/photos/delete', function(req, res) {\n    console.log('delete photo');\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tvar gal = document.galleries[req.params.gallery];\n\t\t\t\tvar p = 0;\n\t\t\t\tfor (var i in gal) {\n\t\t\t\t\tif (gal[p].source.split('/').pop() == req.body.file) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp += 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tvar pp = 0;\n\t\t\t\twhile (true) {\n\t\t\t\t\tif (pp >= p) {\n\t\t\t\t\t\tif (gal[pp + 1]) {\n\t\t\t\t\t\t\tgal[pp] = gal[pp + 1];\n\t\t\t\t\t\t\tdelete gal[pp + 1];\n\t\t\t\t\t\t\tpp += 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse {\n\t\t\t\t\t\t\tif (pp == p) delete gal[pp];\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tpp += 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n\t\t\t\tcollection.update({\n\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t}, document, {\n\t\t\t\t\tupsert: true,\n\t\t\t\t\tsafe: true\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tdb.close();\n\t\t\t\t});\n\t\t\t\tres.redirect('back');\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.get('/:user/:gallery/delete', function(req, res) {\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tvar gals = document.galleries;\n\t\t\t\tfor (var i in gals) {\n\t\t\t\t\tif (i == req.params.gallery) delete gals[i];\n\t\t\t\t}\n\t\t\t\tdocument.galleries = gals;\n\t\t\t\tcollection.update({\n\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t}, document, {\n\t\t\t\t\tupsert: true,\n\t\t\t\t\tsafe: true\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tdb.close();\n\t\t\t\t});\n\t\t\t\tres.redirect('back');\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.get('/:user/galleries/list', function(req, res) {\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tvar galleries = new Array();\n\t\t\t\tvar c = 0;\n\t\t\t\tfor (var i in document.galleries) {\n\t\t\t\t\tgalleries[c] = '/' + req.params.user + '/' + i;\n\t\t\t\t\tc += 1;\n\t\t\t\t}\n\t\t\t\tres.render('galleries', {\n\t\t\t\t\tlayout: false,\n\t\t\t\t\tdata: {\n\t\t\t\t\t\t\"galleries\": galleries,\n\t\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\tdb.close();\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.get('/users/list/account/delete/:user', function(req, res) {\n    console.log('delete user ' + req.params.user);\n    db.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tcollection.remove({\n    \t\t\t\t\"user\": req.params.user\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tdb.close();\n                    res.redirect('back');\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.post('/:user/galleries/new', function(req, res) {\n    console.log('new gallery');\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tif (!document.galleries[req.body.gallery]) {\n\t\t\t\t\tvar data = 'iVBORw0KGgoAAAANSUhEUgAABbIAAAQcCAYAAABAhG2nAAAgAElEQVR4nOzYoQHAIBDAwNL9J34DG2CJuJsgOmtm9gcAAAAAAFH/6wAAAAAAALgxsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAABIM7IBAAAAAEgzsgEAAAAASDOyAQAAAAA47dixAAAAAMAgf+tp7CiM1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAGCTOvMAAADkSURBVAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGBNZAMAAAAAsCayAQAAAABYE9kAAAAAAKyJbAAAAAAA1kQ2AAAAAABrIhsAAAAAgDWRDQAAAADAmsgGAAAAAGAtR1wMJSxM1GUAAAAASUVORK5CYII=';\n\t\t\t\t\tvar buf = new Buffer(data, 'base64');\n\t\t\t\t\tfs.writeFile(__dirname + '/images/' + req.params.user + '-' + req.body.gallery + '-bg.png', buf);\n\t\t\t\t\tvar gal = new Object();\n\t\t\t\t\tdocument.galleries[req.body.gallery] = gal;\n\t\t\t\t\tcollection.update({\n\t\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t\t}, document, {\n\t\t\t\t\t\tupsert: true,\n\t\t\t\t\t\tsafe: true\n\t\t\t\t\t}, function(err, document) {\n\t\t\t\t\t\tdb.close();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tres.redirect('back');\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.post('/users/list/new', function(req, res) {\n    console.log('new user');\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.body.user\n\t\t\t}, function(err, document) {\n\t\t\t\tif (!document) {\n\t\t\t\t\tdocument = new Object();\n\t\t\t\t\tdocument.user = req.body.user;\n                    document.password = req.body.password;\n\t\t\t\t\tdocument.galleries = {};\n\t\t\t\t\tcollection.update({\n\t\t\t\t\t\t\"user\": req.body.user\n\t\t\t\t\t}, document, {\n\t\t\t\t\t\tupsert: true,\n\t\t\t\t\t\tsafe: true\n\t\t\t\t\t}, function(err, document) {\n                        req.session.user = req.body.user;\n                        req.session.password = req.body.password;\n\t\t\t\t\t\tdb.close();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t\tres.redirect('/' + req.body.user + '/galleries/list');\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.post('/users/list/login', function(req, res) {\n    console.log('login by ' + req.body.user);\n    db.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.body.user\n\t\t\t}, function(err, document) {\n\t\t\t\tif(document.password == req.body.password) {\n                    req.session.user = req.body.user;\n                    req.session.password = req.body.password;\n\t                res.redirect('/' + req.body.user + '/galleries/list');\n\t\t\t\t} else {\n                    res.redirect('back');\n\t\t\t\t}\n\t\t\t\tdb.close();\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.get('/', function(req, res) {\n    res.redirect('/krists/home');\n});\n\napp.get('/admin', function(req, res) {\n\tdb.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.find().toArray(function(err, document) {\n\t\t\t\tvar users = new Array();\n\t\t\t\tfor (var i = 0; i < document.length; i++) {\n\t\t\t\t\tusers[i] = document[i].user;\n\t\t\t\t}\n\t\t\t\tres.render('users', {\n\t\t\t\t\tlayout: false,\n\t\t\t\t\tdata: users\n\t\t\t\t});\n\t\t\t\tdb.close();\n\t\t\t});\n\t\t});\n\t});\n});\n\napp.get('/fbauth', function(req, res) {\n    console.log('Got request');\n\tvar appId = \"151679494937877\";    \n\tvar appSecret = \"1e919b67ac456f708d5827576e3dd2fa\";    \n\tvar myUrl = \"http://code.kristsauders.com:8085/fbauth\";\n\n\tvar code = url.parse(req.url, true).query.code;\n\n\t    \n\tif (!code) {        \n\t\tvar dialogUrl = \"http://www.facebook.com/dialog/oauth?scope=user_photos&client_id=\" + appId + \"&redirect_uri=\" + encodeURIComponent(myUrl);   \n        console.log('Redirecting to FBauth at ' + dialogUrl);\n        res.redirect(dialogUrl);\n\t\treturn;    \n\t}\n\n    console.log('Got request with code ' + code);\n\trest.get(\"https://graph.facebook.com/oauth/access_token?client_id=\" + appId + \"&redirect_uri=\" + encodeURIComponent(myUrl) + \"&client_secret=\" + appSecret + \"&code=\" + code).on('complete', function(data) {\n\t\tconsole.log('Got response from Facebook: ' + data);\n        req.session.token = data;\n\t\tres.redirect('/fbphotos');\n\t});\n});\n\napp.get('/fbphotos', function(req, res) {\n\trest.get(\"https://graph.facebook.com/me?\" + req.session.token).on('complete', function(data) {\n        console.log(data[0]);\n        console.log('User name is ' + data[0].name + ' and user ID is ' + data[0].id);\n        rest.get(\"https://graph.facebook.com/\" + data.id + \"/albums?\" + req.session.token).on('complete', function(data) {\n            console.log(data);\n//\t\tvar b = \"\";\n//\t\tfor (var i in data) {\n//\t\t\tb += '<br/>' + data[i].name + ' ' + data[i].id + ' <img src=\"' + data[i]['cover_photo'] + '\"/>';\n//\t\t}\n            res.send(data);\n        });\n//\t\tres.render('index', {\n//            layout: false,\n//            data: photos\n//            });\n\t});\n});\n\napp.get('/fbtest', function(req, res) {\n    rest.get(\"https://graph.facebook.com/me?access_token=AAACJ86JqXRUBAPzXmsaCNiZBttPxVLOtbw9P5zTJDpHjzUgu7vMS9zHpvbVE4FFXAPBVsEXFnK4DSF6uYEZCBZCbaSTIgZA9GzPgs9DoqlEBWYE63UhE\").on('complete', function(data) {\n        var r = JSON.parse(data);\n        //console.log(r);\n        console.log('User name is ' + r.name + ' and user ID is ' + r.id);\n        rest.get(\"https://graph.facebook.com/\" + r.id + \"/albums?access_token=AAACJ86JqXRUBAPzXmsaCNiZBttPxVLOtbw9P5zTJDpHjzUgu7vMS9zHpvbVE4FFXAPBVsEXFnK4DSF6uYEZCBZCbaSTIgZA9GzPgs9DoqlEBWYE63UhE\").on('complete', function(data) {\n            var p = JSON.parse(data);\n            var b = \"\";\n            for (var i in p.data) {\n            \tb += '<br/>' + p.data[i].name + ' ' + p.data[i].id + ' <img src=\"https://graph.facebook.com/' + p.data[i].id + '/picture?type=small&access_token=AAACJ86JqXRUBAPzXmsaCNiZBttPxVLOtbw9P5zTJDpHjzUgu7vMS9zHpvbVE4FFXAPBVsEXFnK4DSF6uYEZCBZCbaSTIgZA9GzPgs9DoqlEBWYE63UhE\">';\n            }\n            res.send(b);\n        });\n\t});\n});\n\napp.get('/fbtest2', function(req, res) {\n    rest.get(\"https://graph.facebook.com/me?access_token=AAACJ86JqXRUBAPzXmsaCNiZBttPxVLOtbw9P5zTJDpHjzUgu7vMS9zHpvbVE4FFXAPBVsEXFnK4DSF6uYEZCBZCbaSTIgZA9GzPgs9DoqlEBWYE63UhE\").on('complete', function(data) {\n        var r = JSON.parse(data);\n        //console.log(r);\n        console.log('User name is ' + r.name + ' and user ID is ' + r.id);\n        rest.get(\"https://graph.facebook.com/\" + r.id + \"/albums?access_token=AAACJ86JqXRUBAPzXmsaCNiZBttPxVLOtbw9P5zTJDpHjzUgu7vMS9zHpvbVE4FFXAPBVsEXFnK4DSF6uYEZCBZCbaSTIgZA9GzPgs9DoqlEBWYE63UhE\").on('complete', function(data) {\n            var p = JSON.parse(data);\n            rest.get(\"https://graph.facebook.com/\" + p.data[0].id + \"/photos?access_token=AAACJ86JqXRUBAPzXmsaCNiZBttPxVLOtbw9P5zTJDpHjzUgu7vMS9zHpvbVE4FFXAPBVsEXFnK4DSF6uYEZCBZCbaSTIgZA9GzPgs9DoqlEBWYE63UhE\").on('complete', function(data) {\n                var k = JSON.parse(data);\n                var b = \"\";\n                for (var i in k.data) {\n                    console.log(k.data[i].images[0].source);\n                    b += '<br/><img src=\"' + k.data[i].images[0].source + '\">';\n                }\n                res.send(b);\n            });\n        });\n\t});\n});\n\napp.listen(8080);\nconsole.log('Started up successfully.');"]],"start1":0,"start2":0,"length1":0,"length2":31188}]],"length":31188}
{"contributors":[],"silentsave":false,"ts":1347043340911,"patch":[[{"diffs":[[0,"ick');\n\n"],[1,"//Configure path to ImageMagick\n//"],[0,"im.ident"]],"start1":338,"start2":338,"length1":16,"length2":50},{"diffs":[[0,"ntify';\n"],[1,"//"],[0,"im.conve"]],"start1":412,"start2":412,"length1":16,"length2":18},{"diffs":[[0,"onvert';"],[1,"\nim.identify.path = '/opt/local/bin/identify';\nim.convert.path = '/opt/local/bin/convert';"],[0,"\n\napp.us"]],"start1":451,"start2":451,"length1":16,"length2":106}]],"length":31314,"saved":false}
{"ts":1347049409889,"patch":[[{"diffs":[[0,"                "],[1,"//"],[0,"res.redirect('/'"]],"start1":26673,"start2":26673,"length1":32,"length2":34},{"diffs":[[0,"ies/list');\n"],[1,"                    res.send('success');\n"],[0,"\t\t\t\t} else {"]],"start1":26734,"start2":26734,"length1":24,"length2":65}]],"length":31357,"saved":false}
{"ts":1347049464996,"patch":[[{"diffs":[[0,"    "],[-1,"res.send('success');\n\t\t\t\t} else {"],[1,"console.log('right');\n                    res.send('success');\n\t\t\t\t} else {\n                    console.log('wrong');"],[0,"\n   "]],"start1":26762,"start2":26762,"length1":41,"length2":125}]],"length":31441,"saved":false}
{"ts":1347049524748,"patch":[[{"diffs":[[0,"og('"],[-1,"right"],[1,"Correct Password"],[0,"');\n"]],"start1":26775,"start2":26775,"length1":13,"length2":24},{"diffs":[[0,"og('"],[-1,"w"],[1,"W"],[0,"rong"],[1," Password"],[0,"');\n"]],"start1":26882,"start2":26882,"length1":13,"length2":22}]],"length":31461,"saved":false}
{"ts":1347049968270,"patch":[[{"diffs":[[0,"        "],[-1,"//"],[0,"res.redi"]],"start1":26681,"start2":26681,"length1":18,"length2":16},{"diffs":[[0,"');\n"],[-1,"                    res.send('success');\n"],[0,"\t\t\t\t"]],"start1":26793,"start2":26793,"length1":49,"length2":8}]],"length":31418,"saved":false}
{"ts":1347050718587,"patch":[[{"diffs":[[0,"\t\t});\n\t});\n});\n\n"],[1,"app.post('/users/list/logout', function(req, res) {\n    console.log('Logout by ' + req.body.user);\n    req.session.user = '';\n    req.session.password = '';\n    res.redirect('/users/list');\n});\n\n"],[0,"app.get('/', fun"]],"start1":26932,"start2":26932,"length1":32,"length2":227}]],"length":31613,"saved":false}
{"ts":1347050821448,"patch":[[{"diffs":[[0,"gout by ' + req."],[-1,"body"],[1,"session"],[0,".user);\n    req."]],"start1":27019,"start2":27019,"length1":36,"length2":39}]],"length":31616,"saved":false}
{"ts":1347050846524,"patch":[[{"diffs":[[0,"le.log('"],[-1,"l"],[1,"L"],[0,"ogin by "]],"start1":26303,"start2":26303,"length1":17,"length2":17}]],"length":31616,"saved":false}
{"ts":1347053178830,"patch":[[{"diffs":[[0,"images'));\n\n"],[1,"//"],[0,"app.get('/:u"]],"start1":879,"start2":879,"length1":24,"length2":26},{"diffs":[[0,"ion(req, res) {\n"],[1,"//"],[0,"    console.log("]],"start1":930,"start2":930,"length1":32,"length2":34},{"diffs":[[0," request');\n"],[1,"//"],[0,"    res.rend"]],"start1":973,"start2":973,"length1":24,"length2":26},{"diffs":[[0,"raw', {\n"],[1,"//"],[0,"\t\tlayout"]],"start1":1004,"start2":1004,"length1":16,"length2":18},{"diffs":[[0," false,\n"],[1,"//"],[0,"\t\tdata: "]],"start1":1023,"start2":1023,"length1":16,"length2":18},{"diffs":[[0,"ata: {}\n"],[1,"//"],[0,"\t});\n"],[1,"//"],[0,"});\n"],[-1,"\n"],[1,"//\n//"],[0,"app.get("]],"start1":1036,"start2":1036,"length1":26,"length2":34},{"diffs":[[0,"ion(req, res) {\n"],[1,"//"],[0,"    console.log("]],"start1":1105,"start2":1105,"length1":32,"length2":34},{"diffs":[[0," get');\n"],[1,"//"],[0,"\tres.sen"]],"start1":1153,"start2":1153,"length1":16,"length2":18},{"diffs":[[0,"'</form>');\n"],[1,"//"],[0,"});\n\nfunctio"]],"start1":1339,"start2":1339,"length1":24,"length2":26},{"diffs":[[0,"og('"],[-1,"n"],[1,"N"],[0,"ew user"],[-1,"'"],[1," ' + req.body.user"],[0,");\n\t"]],"start1":25528,"start2":25528,"length1":17,"length2":34}]],"length":31657,"saved":false}
{"ts":1347055935285,"patch":[[{"diffs":[[0,"es'));\n\n"],[-1,"//"],[0,"app.get("]],"start1":883,"start2":883,"length1":18,"length2":16},{"diffs":[[0,"ion(req, res) {\n"],[-1,"//"],[0,"    console.log("]],"start1":928,"start2":928,"length1":34,"length2":32},{"diffs":[[0,"uest');\n"],[-1,"//"],[0,"    res."]],"start1":973,"start2":973,"length1":18,"length2":16},{"diffs":[[0,"raw', {\n"],[-1,"//"],[0,"\t\tlayout"]],"start1":998,"start2":998,"length1":18,"length2":16},{"diffs":[[0," false,\n"],[-1,"//"],[0,"\t\tdata: "]],"start1":1015,"start2":1015,"length1":18,"length2":16},{"diffs":[[0," {}\n"],[-1,"//"],[0,"\t});\n"],[-1,"//"],[0,"});\n"],[-1,"//"],[0,"\n//a"]],"start1":1030,"start2":1030,"length1":23,"length2":17},{"diffs":[[0,"   console.log('"],[-1,"g"],[1,"G"],[0,"ot new photo pos"]],"start1":4782,"start2":4782,"length1":33,"length2":33}]],"length":31641,"saved":false}
{"contributors":[],"silentsave":false,"ts":1347319981972,"patch":[[{"diffs":[[0,"isten(80"],[-1,"80"],[0,");\nconso"]],"start1":31588,"start2":31588,"length1":18,"length2":16}]],"length":31639,"saved":false}
{"ts":1347319999292,"patch":[[{"diffs":[[0,"isten(80"],[1,"81"],[0,");\nconso"]],"start1":31588,"start2":31588,"length1":16,"length2":18}]],"length":31641,"saved":false}
{"ts":1347320013508,"patch":[[{"diffs":[[0,"sten(808"],[-1,"1"],[1,"0"],[0,");\nconso"]],"start1":31589,"start2":31589,"length1":17,"length2":17}]],"length":31641,"saved":false}
{"ts":1347320026360,"patch":[[{"diffs":[[0,"sten(808"],[-1,"0"],[1,"1"],[0,");\nconso"]],"start1":31589,"start2":31589,"length1":17,"length2":17}]],"length":31641,"saved":false}
{"ts":1347321524910,"patch":[[{"diffs":[[0,"req.body.user);\n"],[1,"    if((req.body.user!=null) && (req.body.password!=null)) {\n    "],[0,"    db.open(func"]],"start1":26349,"start2":26349,"length1":32,"length2":97},{"diffs":[[0,"tion(err, db) {\n"],[1,"    "],[0,"\t\tdb.collection("]],"start1":26446,"start2":26446,"length1":32,"length2":36},{"diffs":[[0,", collection) {\n"],[1,"    "],[0,"\t\t\tcollection.fi"]],"start1":26503,"start2":26503,"length1":32,"length2":36},{"diffs":[[0,"ction.findOne({\n"],[1,"    "],[0,"\t\t\t\t\"user\": req."]],"start1":26531,"start2":26531,"length1":32,"length2":36},{"diffs":[[0,": req.body.user\n"],[1,"    "],[0,"\t\t\t}, function(e"]],"start1":26561,"start2":26561,"length1":32,"length2":36},{"diffs":[[0,"document) {\n"],[1,"    "],[0,"\t\t\t\tif(docum"]],"start1":26601,"start2":26601,"length1":24,"length2":28},{"diffs":[[0,"                "],[1,"   "],[1," "],[0,"req.session.user"]],"start1":26670,"start2":26670,"length1":32,"length2":36},{"diffs":[[0," req.body.user;\n"],[1,"    "],[0,"                "]],"start1":26708,"start2":26708,"length1":32,"length2":36},{"diffs":[[0,"ssword;\n"],[1,"    "],[0,"\t       "]],"start1":26782,"start2":26782,"length1":16,"length2":20},{"diffs":[[0,"                "],[1,"    "],[0,"console.log('Cor"]],"start1":26870,"start2":26870,"length1":32,"length2":36},{"diffs":[[0,"Password');\n"],[1,"    "],[0,"\t\t\t\t} else {"]],"start1":26911,"start2":26911,"length1":24,"length2":28},{"diffs":[[0,"                "],[1,"    "],[0,"console.log('Wro"]],"start1":26944,"start2":26944,"length1":32,"length2":36},{"diffs":[[0,"                "],[1,"    "],[0,"res.redirect('ba"]],"start1":26999,"start2":26999,"length1":32,"length2":36},{"diffs":[[0,"ct('back');\n"],[1,"    "],[0,"\t\t\t\t}\n"],[1,"    "],[0,"\t\t\t\tdb.close"]],"start1":27029,"start2":27029,"length1":30,"length2":38},{"diffs":[[0,"lose();\n"],[1,"    "],[0,"\t\t\t});\n"],[1,"    "],[0,"\t\t});\n"],[-1,"\t});"],[1,"    \t});\n    }"],[0,"\n});\n\nap"]],"start1":27063,"start2":27063,"length1":33,"length2":51}]],"length":31780,"saved":false}
{"ts":1347321567641,"patch":[[{"diffs":[[0," if("],[-1,"("],[0,"req.body"],[-1,".user"],[0,"!=null)"],[-1," && (req.body.password!=null))"],[0," {\n "]],"start1":26368,"start2":26368,"length1":59,"length2":23}]],"length":31744,"saved":false}
{"ts":1347321776074,"patch":[[{"diffs":[[0,"body.user);\n"],[1,"    console.log(req.body);\n"],[0,"    if(req.b"]],"start1":26353,"start2":26353,"length1":24,"length2":51}]],"length":31771,"saved":false}
{"ts":1347321822438,"patch":[[{"diffs":[[0,"body"],[-1,"!=null"],[1,".user.length>0"],[0,") {\n"]],"start1":26403,"start2":26403,"length1":14,"length2":22}]],"length":31779,"saved":false}
{"ts":1347321825161,"patch":[[{"diffs":[[0,"r);\n"],[-1,"    console.log(req.body);\n"],[0,"    "]],"start1":26361,"start2":26361,"length1":35,"length2":8}]],"length":31752,"saved":false}
{"contributors":[],"silentsave":false,"ts":1347566325243,"patch":[[{"diffs":[[0,"sten(808"],[-1,"1"],[1,"0"],[0,");\nconso"]],"start1":31700,"start2":31700,"length1":17,"length2":17}]],"length":31752,"saved":false}
{"ts":1347567553165,"patch":[[{"diffs":[[0,"le.log('"],[-1,"upsert"],[1,"Coords update"],[0,"');\n\tdb."]],"start1":9861,"start2":9861,"length1":22,"length2":29}]],"length":31759,"saved":false}
{"ts":1347567738354,"patch":[[{"diffs":[[0,"\t\t});\n\t});\n});\n\n"],[1,"app.post('/:user/:gallery/updateLink', function(req, res) {\n    console.log('Link update');\n    db.open(function(err, db) {\n\t\tdb.collection('users', function(err, collection) {\n\t\t\tcollection.findOne({\n\t\t\t\t\"user\": req.params.user\n\t\t\t}, function(err, document) {\n\t\t\t\tvar gal = document.galleries[req.params.gallery];\n\t\t\t\tvar p = 0;\n\t\t\t\tfor (var i in gal) {\n\t\t\t\t\tif (gal[p].source.split('/').pop() == req.body.image) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\telse {\n\t\t\t\t\t\tp += 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tgal[p].link = req.body.link;\n\t\t\t\tdocument.galleries[req.params.gallery] = gal;\n\t\t\t\tcollection.update({\n\t\t\t\t\t\"user\": req.params.user\n\t\t\t\t}, document, {\n\t\t\t\t\tupsert: true,\n\t\t\t\t\tsafe: true\n\t\t\t\t}, function(err, document) {\n\t\t\t\t\tdb.close();\n\t\t\t\t});\n\t\t\t\tres.redirect('back');\n\t\t\t});\n\t\t});\n\t});\n});\n\n"],[0,"app.post('/:user"]],"start1":10726,"start2":10726,"length1":32,"length2":804}]],"length":32531,"saved":false}
{"ts":1347568973839,"patch":[[{"diffs":[[0,"k update');\n"],[1,"    console.log(req.params.user + ' ' + req.params.gallery + ' ' + req.body.file);\n"],[0,"    db.open("]],"start1":10822,"start2":10822,"length1":24,"length2":107},{"diffs":[[0,"p() == req.body."],[-1,"imag"],[1,"fil"],[0,"e) {\n\t\t\t\t\t\tbreak"]],"start1":11216,"start2":11216,"length1":36,"length2":35}]],"length":32613,"saved":false}
{"ts":1347569123775,"patch":[[{"diffs":[[0,"log("],[-1,"req.params.user + ' ' + req.params.gallery + ' ' + "],[0,"req."]],"start1":10846,"start2":10846,"length1":59,"length2":8},{"diffs":[[0,"te photo');\n"],[1,"    console.log(req.body.file);\n"],[0,"\tdb.open(fun"]],"start1":11629,"start2":11629,"length1":24,"length2":56}]],"length":32594,"saved":false}
{"ts":1347569360696,"patch":[[{"diffs":[[0,"eq.body.file) {\n"],[1,"                        console.log('found ' +p);\n                        console.log(gal[p]);\n"],[0,"\t\t\t\t\t\tbreak;\n\t\t\t"]],"start1":11173,"start2":11173,"length1":32,"length2":127},{"diffs":[[0,"ody.file) {\n"],[1,"                        console.log('found ' +p);\n                        console.log(gal[p]);\n"],[0,"\t\t\t\t\t\tbreak;"]],"start1":12076,"start2":12076,"length1":24,"length2":119}]],"length":32784,"saved":false}
{"ts":1347570310812,"patch":[[{"diffs":[[0,"').pop()"],[-1,"+'.jpg';"],[0,";\n    \t\t"]],"start1":6145,"start2":6145,"length1":24,"length2":16}]],"length":32776,"saved":false}
{"ts":1347570468454,"patch":[[{"diffs":[[0,"');\n"],[-1,"    console.log(req.body.file);\n"],[0,"    "]],"start1":10822,"start2":10822,"length1":40,"length2":8},{"diffs":[[0,"tion(err, db) {\n"],[1,""],[0,"\t\tdb.collection("]],"start1":10842,"start2":10842,"length1":32,"length2":32},{"diffs":[[0,") {\n"],[-1,"                        console.log('found ' +p);\n                        console.log(gal[p]);\n"],[0,"\t\t\t\t"]],"start1":11145,"start2":11145,"length1":103,"length2":8},{"diffs":[[0,"');\n"],[-1,"    console.log(req.body.file);\n"],[0,"\tdb."]],"start1":11597,"start2":11597,"length1":40,"length2":8},{"diffs":[[0,"var i in gal) {\n"],[1,""],[0,"\t\t\t\t\tif (gal[p]."]],"start1":11845,"start2":11845,"length1":32,"length2":32},{"diffs":[[0,") {\n"],[-1,"                        console.log('found ' +p);\n                        console.log(gal[p]);\n"],[0,"\t\t\t\t"]],"start1":11917,"start2":11917,"length1":103,"length2":8}]],"length":32522,"saved":false}
